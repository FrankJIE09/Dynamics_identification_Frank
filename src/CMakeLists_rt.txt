#-------------------------------------------------------------------------------
# RT mode example executables setup

# Find ROS2 packages (optional, for ROS2 integration examples)
# Set CMAKE_PREFIX_PATH to include ROS2 paths if available
if(DEFINED ENV{AMENT_PREFIX_PATH})
    list(APPEND CMAKE_PREFIX_PATH $ENV{AMENT_PREFIX_PATH})
endif()
if(EXISTS /opt/ros/humble)
    list(APPEND CMAKE_PREFIX_PATH /opt/ros/humble)
endif()

find_package(rclcpp QUIET)
find_package(geometry_msgs QUIET)
find_package(rcl_interfaces QUIET)
find_package(rosidl_typesupport_cpp QUIET)

# Here puts required example source files
set(RT_EXAMPLES
    joint_position_control
    joint_impedance_control
    cartesian_impedance_control
    move_commands
    joint_s_line
    cartesian_s_line
    rt_industrial
    servoj_demo
    )

foreach(example ${RT_EXAMPLES})
    add_executable(${example} ${example}.cpp ${EXAMPLE_HEADERS})
    target_include_directories(${example} PUBLIC
        ${SHARED_INCLUDEDIR})
    target_link_libraries(${example} Rokae::Rokae eigen Threads::Threads g3log kdl)
    if(MSVC)
        add_compile_definitions(_USE_MATH_DEFINES)
    endif() # for M_PI in cmath
endforeach()

# check for xMateModel library option
if(XCORE_USE_XMATE_MODEL)
    set(EXAMPLES_USE_XMATEMODEL
        torque_control
        follow_joint_position
        )
    foreach(example ${EXAMPLES_USE_XMATEMODEL})
        add_executable(${example} ${example}.cpp ${EXAMPLE_HEADERS})
        target_include_directories(${example} PUBLIC
            ${SHARED_INCLUDEDIR})
        target_link_libraries(${example} Rokae::Rokae eigen Threads::Threads g3log kdl)
        target_compile_definitions(${example} PUBLIC XMATEMODEL_LIB_SUPPORTED)
    endforeach()
    
    # Add dynamics_identification executable (requires xMateModel and Pinocchio)
    # 保留原始的综合程序
    add_executable(dynamics_identification dynamics_identification.cpp ${EXAMPLE_HEADERS})
    target_include_directories(dynamics_identification PUBLIC
        ${SHARED_INCLUDEDIR})
    target_link_libraries(dynamics_identification 
        Rokae::Rokae
        eigen
        Threads::Threads
        g3log
        kdl
        pinocchio_lib)
    target_compile_features(dynamics_identification PUBLIC c_std_99 cxx_std_17)
    target_compile_definitions(dynamics_identification PUBLIC XMATEMODEL_LIB_SUPPORTED)
    # Add URDF file path as compile definition
    set(URDF_FILE_PATH "${CMAKE_CURRENT_SOURCE_DIR}/AR5-5_07R-W4C4A2.urdf")
    target_compile_definitions(dynamics_identification PRIVATE URDF_FILE_PATH="${URDF_FILE_PATH}")
    # Add Eigen3 include directory for Pinocchio
    target_include_directories(dynamics_identification PUBLIC /usr/include/eigen3)
    target_compile_definitions(dynamics_identification PRIVATE PINOCCHIO_WITHOUT_EIGEN_TENSOR_SUPPORT)
    if(MSVC)
        target_compile_definitions(dynamics_identification PRIVATE _USE_MATH_DEFINES)
    endif()
    # Add to examples list
    set(EXAMPLES_USE_XMATEMODEL ${EXAMPLES_USE_XMATEMODEL} dynamics_identification)
    
    # Add dynamics_data_collection executable (数据采集程序)
    add_executable(dynamics_data_collection dynamics_data_collection.cpp ${EXAMPLE_HEADERS})
    target_include_directories(dynamics_data_collection PUBLIC
        ${SHARED_INCLUDEDIR})
    target_link_libraries(dynamics_data_collection 
        Rokae::Rokae
        eigen
        Threads::Threads
        g3log
        kdl)
    target_compile_features(dynamics_data_collection PUBLIC c_std_99 cxx_std_17)
    target_compile_definitions(dynamics_data_collection PUBLIC XMATEMODEL_LIB_SUPPORTED)
    if(MSVC)
        target_compile_definitions(dynamics_data_collection PRIVATE _USE_MATH_DEFINES)
    endif()
    set(EXAMPLES_USE_XMATEMODEL ${EXAMPLES_USE_XMATEMODEL} dynamics_data_collection)
    
    # Add dynamics_parameter_estimation executable (参数计算程序，需要Pinocchio)
    add_executable(dynamics_parameter_estimation dynamics_parameter_estimation.cpp ${EXAMPLE_HEADERS})
    target_include_directories(dynamics_parameter_estimation PUBLIC
        ${SHARED_INCLUDEDIR})
    target_link_libraries(dynamics_parameter_estimation 
        eigen
        Threads::Threads
        g3log
        kdl
        pinocchio_lib)
    target_compile_features(dynamics_parameter_estimation PUBLIC c_std_99 cxx_std_17)
    # Add URDF file path as compile definition
    target_compile_definitions(dynamics_parameter_estimation PRIVATE URDF_FILE_PATH="${URDF_FILE_PATH}")
    # Add Eigen3 include directory for Pinocchio
    target_include_directories(dynamics_parameter_estimation PUBLIC /usr/include/eigen3)
    target_compile_definitions(dynamics_parameter_estimation PRIVATE PINOCCHIO_WITHOUT_EIGEN_TENSOR_SUPPORT)
    if(MSVC)
        target_compile_definitions(dynamics_parameter_estimation PRIVATE _USE_MATH_DEFINES)
    endif()
    set(EXAMPLES_USE_XMATEMODEL ${EXAMPLES_USE_XMATEMODEL} dynamics_parameter_estimation)
endif()

# ROS2 integration examples (only build if ROS2 is available)
if(rclcpp_FOUND AND geometry_msgs_FOUND)
    add_executable(subscribe_force_sensor subscribe_force_sensor.cpp ${EXAMPLE_HEADERS})
    target_include_directories(subscribe_force_sensor PUBLIC
        ${SHARED_INCLUDEDIR})
    
    # Find ROS2 libraries directly
    find_library(RCLCPP_LIB 
        NAMES rclcpp
        PATHS /opt/ros/humble/lib
        NO_DEFAULT_PATH)
    find_library(ROSIDL_TYPESUPPORT_CPP_LIB
        NAMES rosidl_typesupport_cpp
        PATHS /opt/ros/humble/lib
        NO_DEFAULT_PATH)
    find_library(ROSIDL_RUNTIME_CPP_LIB
        NAMES rosidl_runtime_cpp
        PATHS /opt/ros/humble/lib
        NO_DEFAULT_PATH)
    find_library(RCL_LIB
        NAMES rcl
        PATHS /opt/ros/humble/lib
        NO_DEFAULT_PATH)
    find_library(STATISTICS_COLLECTOR_LIB
        NAMES libstatistics_collector
        PATHS /opt/ros/humble/lib
        NO_DEFAULT_PATH)
    find_library(GEOMETRY_MSGS_TYPESUPPORT_LIB
        NAMES geometry_msgs__rosidl_typesupport_cpp
        PATHS /opt/ros/humble/lib
        NO_DEFAULT_PATH)
    find_library(STATISTICS_MSGS_TYPESUPPORT_LIB
        NAMES statistics_msgs__rosidl_typesupport_cpp
        PATHS /opt/ros/humble/lib
        NO_DEFAULT_PATH)
    find_library(TRACETOOLS_LIB
        NAMES tracetools
        PATHS /opt/ros/humble/lib
        NO_DEFAULT_PATH)
    find_library(RMW_LIB
        NAMES rmw
        PATHS /opt/ros/humble/lib
        NO_DEFAULT_PATH)
    find_library(RCUTILS_LIB
        NAMES rcutils
        PATHS /opt/ros/humble/lib
        NO_DEFAULT_PATH)
    find_library(RCL_YAML_PARAM_PARSER_LIB
        NAMES rcl_yaml_param_parser
        PATHS /opt/ros/humble/lib
        NO_DEFAULT_PATH)
    find_library(RCL_INTERFACES_TYPESUPPORT_LIB
        NAMES rcl_interfaces__rosidl_typesupport_cpp
        PATHS /opt/ros/humble/lib
        NO_DEFAULT_PATH)
    
    # Link all required libraries
    if(RCLCPP_LIB)
        target_link_libraries(subscribe_force_sensor 
            ${RCLCPP_LIB}
            Threads::Threads)
        if(ROSIDL_TYPESUPPORT_CPP_LIB)
            target_link_libraries(subscribe_force_sensor ${ROSIDL_TYPESUPPORT_CPP_LIB})
        endif()
        if(ROSIDL_RUNTIME_CPP_LIB)
            target_link_libraries(subscribe_force_sensor ${ROSIDL_RUNTIME_CPP_LIB})
        endif()
        if(RCL_LIB)
            target_link_libraries(subscribe_force_sensor ${RCL_LIB})
        endif()
        if(STATISTICS_COLLECTOR_LIB)
            target_link_libraries(subscribe_force_sensor ${STATISTICS_COLLECTOR_LIB})
        endif()
        if(GEOMETRY_MSGS_TYPESUPPORT_LIB)
            target_link_libraries(subscribe_force_sensor ${GEOMETRY_MSGS_TYPESUPPORT_LIB})
        endif()
        if(STATISTICS_MSGS_TYPESUPPORT_LIB)
            target_link_libraries(subscribe_force_sensor ${STATISTICS_MSGS_TYPESUPPORT_LIB})
        endif()
        if(TRACETOOLS_LIB)
            target_link_libraries(subscribe_force_sensor ${TRACETOOLS_LIB})
        endif()
        if(RMW_LIB)
            target_link_libraries(subscribe_force_sensor ${RMW_LIB})
        endif()
        if(RCUTILS_LIB)
            target_link_libraries(subscribe_force_sensor ${RCUTILS_LIB})
        endif()
        if(RCL_YAML_PARAM_PARSER_LIB)
            target_link_libraries(subscribe_force_sensor ${RCL_YAML_PARAM_PARSER_LIB})
        endif()
        if(RCL_INTERFACES_TYPESUPPORT_LIB)
            target_link_libraries(subscribe_force_sensor ${RCL_INTERFACES_TYPESUPPORT_LIB})
        endif()
    else()
        message(WARNING "Could not find rclcpp library")
        target_link_libraries(subscribe_force_sensor Threads::Threads)
    endif()
    
    # Include directories - add all ROS2 include paths
    target_include_directories(subscribe_force_sensor PUBLIC
        /opt/ros/humble/include)
    # Also add from find_package if available
    if(rclcpp_INCLUDE_DIRS)
        target_include_directories(subscribe_force_sensor PUBLIC
            ${rclcpp_INCLUDE_DIRS})
    endif()
    if(geometry_msgs_INCLUDE_DIRS)
        target_include_directories(subscribe_force_sensor PUBLIC
            ${geometry_msgs_INCLUDE_DIRS})
    endif()
    if(rcl_interfaces_INCLUDE_DIRS)
        target_include_directories(subscribe_force_sensor PUBLIC
            ${rcl_interfaces_INCLUDE_DIRS})
    endif()
    
    target_compile_features(subscribe_force_sensor PUBLIC c_std_99 cxx_std_17)
    if(MSVC)
        target_compile_definitions(subscribe_force_sensor PRIVATE _USE_MATH_DEFINES)
    endif()
    
    # Add hybrid_force_position_control executable (requires ROS2 and xMateModel)
    if(XCORE_USE_XMATE_MODEL)
        add_executable(hybrid_force_position_control hybrid_force_position_control.cpp ${EXAMPLE_HEADERS})
        target_include_directories(hybrid_force_position_control PUBLIC
            ${SHARED_INCLUDEDIR})
        
        # Link all required libraries (same as subscribe_force_sensor)
        if(RCLCPP_LIB)
            target_link_libraries(hybrid_force_position_control 
                ${RCLCPP_LIB}
                Rokae::Rokae
                eigen
                Threads::Threads
                g3log
                kdl
                pinocchio_lib)
            if(ROSIDL_TYPESUPPORT_CPP_LIB)
                target_link_libraries(hybrid_force_position_control ${ROSIDL_TYPESUPPORT_CPP_LIB})
            endif()
            if(ROSIDL_RUNTIME_CPP_LIB)
                target_link_libraries(hybrid_force_position_control ${ROSIDL_RUNTIME_CPP_LIB})
            endif()
            if(RCL_LIB)
                target_link_libraries(hybrid_force_position_control ${RCL_LIB})
            endif()
            if(STATISTICS_COLLECTOR_LIB)
                target_link_libraries(hybrid_force_position_control ${STATISTICS_COLLECTOR_LIB})
            endif()
            if(GEOMETRY_MSGS_TYPESUPPORT_LIB)
                target_link_libraries(hybrid_force_position_control ${GEOMETRY_MSGS_TYPESUPPORT_LIB})
            endif()
            if(STATISTICS_MSGS_TYPESUPPORT_LIB)
                target_link_libraries(hybrid_force_position_control ${STATISTICS_MSGS_TYPESUPPORT_LIB})
            endif()
            if(TRACETOOLS_LIB)
                target_link_libraries(hybrid_force_position_control ${TRACETOOLS_LIB})
            endif()
            if(RMW_LIB)
                target_link_libraries(hybrid_force_position_control ${RMW_LIB})
            endif()
            if(RCUTILS_LIB)
                target_link_libraries(hybrid_force_position_control ${RCUTILS_LIB})
            endif()
            if(RCL_YAML_PARAM_PARSER_LIB)
                target_link_libraries(hybrid_force_position_control ${RCL_YAML_PARAM_PARSER_LIB})
            endif()
            if(RCL_INTERFACES_TYPESUPPORT_LIB)
                target_link_libraries(hybrid_force_position_control ${RCL_INTERFACES_TYPESUPPORT_LIB})
            endif()
        else()
            message(WARNING "Could not find rclcpp library for hybrid_force_position_control")
            target_link_libraries(hybrid_force_position_control 
                Rokae::Rokae
                eigen
                Threads::Threads
                g3log
                kdl
                pinocchio_lib)
        endif()
        
        # Include directories
        target_include_directories(hybrid_force_position_control PUBLIC
            /opt/ros/humble/include)
        if(rclcpp_INCLUDE_DIRS)
            target_include_directories(hybrid_force_position_control PUBLIC
                ${rclcpp_INCLUDE_DIRS})
        endif()
        if(geometry_msgs_INCLUDE_DIRS)
            target_include_directories(hybrid_force_position_control PUBLIC
                ${geometry_msgs_INCLUDE_DIRS})
        endif()
        if(rcl_interfaces_INCLUDE_DIRS)
            target_include_directories(hybrid_force_position_control PUBLIC
                ${rcl_interfaces_INCLUDE_DIRS})
        endif()
        
        target_compile_features(hybrid_force_position_control PUBLIC c_std_99 cxx_std_17)
        target_compile_definitions(hybrid_force_position_control PUBLIC XMATEMODEL_LIB_SUPPORTED)
        # Add URDF file path as compile definition
        set(URDF_FILE_PATH "${CMAKE_CURRENT_SOURCE_DIR}/AR5-5_07R-W4C4A2.urdf")
        target_compile_definitions(hybrid_force_position_control PRIVATE URDF_FILE_PATH="${URDF_FILE_PATH}")
        # Add Eigen3 include directory for Pinocchio (before Pinocchio includes)
        target_include_directories(hybrid_force_position_control PUBLIC /usr/include/eigen3)
        # Try to disable Tensor support if causing issues
        target_compile_definitions(hybrid_force_position_control PRIVATE PINOCCHIO_WITHOUT_EIGEN_TENSOR_SUPPORT)
        if(MSVC)
            target_compile_definitions(hybrid_force_position_control PRIVATE _USE_MATH_DEFINES)
        endif()
        
        set(ROS2_EXAMPLES subscribe_force_sensor hybrid_force_position_control)
    else()
        set(ROS2_EXAMPLES subscribe_force_sensor)
        message(STATUS "xMateModel not supported - skipping hybrid_force_position_control")
    endif()
    message(STATUS "ROS2 found - building ROS2 integration examples")
else()
    message(STATUS "ROS2 not found - skipping ROS2 integration examples")
    set(ROS2_EXAMPLES "")
endif()

#-------------------------------------------------------------------------------
# Installation
install(TARGETS ${RT_EXAMPLES} ${EXAMPLES_USE_XMATEMODEL} ${ROS2_EXAMPLES}
    LIBRARY DESTINATION ${CMAKE_INSTALL_LIBDIR}
    RUNTIME DESTINATION ${CMAKE_INSTALL_BINDIR}
    OPTIONAL
    )
